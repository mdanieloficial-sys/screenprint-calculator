<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Screen Print Calculator</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0b0c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Print Calc">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <meta name="format-detection" content="telephone=no">
  <style>
    :root{
      --bg:#0b0b0c; --card:#121216; --ink:#eaeaea; --muted:#9a9aa1;
      --accent:#f4f4f6; --focus:#3b82f6; --danger:#ef4444; --ring:0 0 0 3px rgba(59,130,246,.35);
      --radius:16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 80% -20%, #1a1a1f 0%, #0b0b0c 60%);
      -webkit-touch-callout:none; -webkit-text-size-adjust:100%;
    }
    .wrap{max-width:920px; margin: env(safe-area-inset-top) auto 0 auto;
      padding: clamp(16px, 3vw, 24px); padding-bottom: calc(16px + env(safe-area-inset-bottom));
    }
    .title{display:flex; align-items:center; gap:12px; margin-bottom:14px;}
    .badge{font-size:12px; color:#0b0b0c; background:#d1fae5; padding:4px 8px; border-radius:999px; font-weight:700; letter-spacing:.3px;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); border-radius:var(--radius);
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05); overflow:hidden;
    }
    .grid{display:grid; grid-template-columns: 1fr 1fr;}
    @media (max-width:860px){ .grid{grid-template-columns:1fr} }
    .pane{padding:16px;} .pane + .pane{border-left:1px solid rgba(255,255,255,.06);}
    @media (max-width:860px){ .pane + .pane{border-left:none; border-top:1px solid rgba(255,255,255,.06)} }
    .row{display:grid; grid-template-columns: 1.3fr 1fr; align-items:center; gap:10px; margin:12px 0;}
    label{font-size:14px; color:var(--muted);}
    input, select{width:100%; background:#0e0e12; color:var(--ink);
      border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:12px 14px; font-size:16px; outline:none;
      transition:.2s border-color,.2s box-shadow;
    }
    input:focus, select:focus{border-color:var(--focus); box-shadow:var(--ring);}
    .seg{display:inline-flex; background:#0e0e12; border:1px solid rgba(255,255,255,.12); border-radius:12px; overflow:hidden}
    .seg button{
      appearance:none; background:transparent; color:#e5e7eb; border:0; padding:8px 12px; cursor:pointer; font-weight:700;
    }
    .seg button + button{border-left:1px solid rgba(255,255,255,.12)}
    .seg button[aria-pressed="true"]{background:#1f2937}
    .seg button[disabled]{opacity:.5; cursor:not-allowed}
    .tag{font-size:12px; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.18); color:#e5e7eb; opacity:.85; margin-left:8px}
    .outputs{display:grid; gap:10px; margin-top:12px;}
    .pill{background:#0e0e12; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center; font-size:16px;}
    .muted{color:var(--muted); font-size:13px}
    .big{font-size:26px; font-weight:800; letter-spacing:.4px;}
    .foot{display:flex; justify-content:space-between; align-items:center; margin-top:12px; gap:10px; flex-wrap:wrap;}
    .btn{appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; font-weight:700;
      background:#111827; color:#e5e7eb; border:1px solid rgba(255,255,255,.1);}
    .btn:hover{filter:brightness(1.05)} .right{text-align:right}
    .notice{margin-top:10px; padding:10px 12px; border-radius:12px; background:rgba(59,130,246,.12); border:1px solid rgba(59,130,246,.35);
      color:#bfdbfe; font-size:14px;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1 style="margin:0">Screen Print Calculator</h1>
      <span class="badge">PWA</span>
    </div>

    <div class="card grid">
      <div class="pane">
        <div class="row">
          <label for="garment">Garment price / piece (no VAT)</label>
          <input id="garment" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 25.00" value="">
        </div>

        <div class="row">
          <label for="colors">Number of colors</label>
          <select id="colors" title="5+ colors forces DTF">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4">4</option>
            <option value="5+">5 or more (DTF)</option>
          </select>
        </div>

        <div class="row">
          <label for="volume">Volume (pcs)</label>
          <input id="volume" type="number" inputmode="numeric" min="1" step="1" placeholder="e.g. 50" value="">
        </div>

        <!-- Buttons: Neck label include/exclude -->
        <div class="row" style="grid-template-columns:1fr auto">
          <label>Neck label (+5 lei incl. VAT)</label>
          <div class="seg" role="group" aria-label="Neck label">
            <button id="neckOn"  type="button" aria-pressed="true">Include</button>
            <button id="neckOff" type="button" aria-pressed="false">Exclude</button>
          </div>
        </div>

        <!-- Buttons: DTF comparison include/exclude -->
        <div class="row" style="grid-template-columns:1fr auto">
          <label>DTF comparison</label>
          <div>
            <div class="seg" role="group" aria-label="DTF compare">
              <button id="dtfOn"  type="button" aria-pressed="true">Include</button>
              <button id="dtfOff" type="button" aria-pressed="false">Exclude</button>
            </div>
            <span id="dtfAutoTag" class="tag" style="display:none">auto</span>
          </div>
        </div>

        <!-- Auto note -->
        <div id="dtfNote" class="notice" style="display:none">
          DTF is auto-enabled because <span id="dtfWhy"></span>.
        </div>

        <div class="foot">
          <button class="btn" id="share">Share prefilled link</button>
          <button class="btn" id="reset">Reset</button>
        </div>
      </div>

      <div class="pane right">
        <!-- Screen print outputs -->
        <div class="muted">SCREEN PRINT — OUTPUTS (no VAT)</div>
        <div class="outputs">
          <div class="pill">
            <span>Price per piece (no VAT)</span>
            <span class="big" id="pppNoVat">0.00</span>
          </div>
          <div class="pill">
            <span>Total price (no VAT)</span>
            <span class="big" id="tpNoVat">0.00</span>
          </div>
        </div>
        <div style="height:12px"></div>
        <div class="muted">SCREEN PRINT — OUTPUTS</div>
        <div class="outputs">
          <div class="pill">
            <span>Price per piece</span>
            <span class="big" id="pppVat">0.00</span>
          </div>
          <div class="pill">
            <span>Total price</span>
            <span class="big" id="tpVat">0.00</span>
          </div>
        </div>

        <div style="height:16px"></div>

        <!-- DTF outputs (comparison) -->
        <div id="dtfBlock" style="display:none; gap:8px">
          <div class="muted">DTF — OUTPUTS (no VAT)</div>
          <div class="outputs">
            <div class="pill">
              <span>DTF price per piece (no VAT)</span>
              <span class="big" id="dtfPppNoVat">0.00</span>
            </div>
            <div class="pill">
              <span>DTF total price (no VAT)</span>
              <span class="big" id="dtfTpNoVat">0.00</span>
            </div>
          </div>
          <div style="height:12px"></div>
          <div class="muted">DTF — OUTPUTS</div>
          <div class="outputs">
            <div class="pill">
              <span>DTF price per piece</span>
              <span class="big" id="dtfPppVat">0.00</span>
            </div>
            <div class="pill">
              <span>DTF total price</span>
              <span class="big" id="dtfTpVat">0.00</span>
            </div>
          </div>
        </div>

        <div class="foot">
          <div class="muted">VAT <span id="vatRateLabel">21%</span> applied. Neck label = 5 lei incl. VAT (auto-handled).</div>
          <button class="btn" id="copy">Copy outputs</button>
        </div>

        <!-- KPI / Target profit widget -->
        <div id="kpi" class="notice" style="margin-top:12px; display:block">
          <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
            <span>Applied margin: <b id="tierLabel">—</b></span>
            <span>Profit/unit (no VAT): <b id="ppu">0.00</b> lei</span>
            <label style="margin-left:auto">Target net profit:
              <input id="targetProfit" type="number" inputmode="decimal" min="0" step="100" value="10000" style="width:130px; margin-left:6px">
            </label>
            <span>Needed volume (SP): <b id="needSp">—</b></span>
            <span>Needed volume (DTF): <b id="needDtf">—</b></span>
          </div>
        </div>

        <!-- Profit breakdown toggle + box -->
        <div class="foot" style="margin-top:16px">
          <button class="btn" id="toggleProfit">Show profit breakdown</button>
        </div>
        <div id="profitBox" class="notice" style="display:none; margin-top:10px">
          <div><b>Active method:</b> <span id="activeMethod">—</span></div>
          <div><b>Volume:</b> <span id="pbVolume">—</span> pcs</div>
          <div><b>Total Revenue (no VAT):</b> <span id="pbRevenue">0.00</span> lei</div>
          <div><b>Total Cost (no VAT):</b> <span id="pbCost">0.00</span> lei</div>
          <div><b>Gross Profit (no VAT):</b> <span id="pbGross">0.00</span> lei</div>
          <div><b>Micro tax (3%):</b> <span id="pbTax">0.00</span> lei</div>
          <div><b>Net Profit:</b> <span id="pbNet">0.00</span> lei</div>
          <div style="margin-top:8px; font-size:13px; opacity:.8">
            *Net profit = after micro-enterprise tax, before personal withdrawals.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ===== CONFIG =====
const CONFIG = {
  currency: "lei",
  vatRate: 0.21,
  micro_tax_rate: 0.03, // pentru calcul volum net target + breakdown

  // Screen print cost model
  setup_per_color: 50,   // lei / color (amortized)
  ink_per_color: 5,      // lei / color
  labor_per_garment: 3,  // lei / garment
  overhead_rate: 0.10,   // +10% overhead

  // margin by volume (DESCENDING by min!)
  margin_tiers: [
    { min: 200, rate: 0.35 },
    { min: 100, rate: 0.40 },
    { min:  50, rate: 0.45 },
    { min:  25, rate: 0.50 },
    { min:  10, rate: 0.55 },
    { min:   1, rate: 0.55 }
  ],

  // DTF
  dtf_price_no_vat: 35,                 // lei / garment (no VAT)
  neck_label_vat_inclusive_add: 5,      // 5 lei AFTER VAT
  precision: 2
};

function getMarginRate(qty){
  for (var i=0;i<CONFIG.margin_tiers.length;i++){
    if (qty >= CONFIG.margin_tiers[i].min) return CONFIG.margin_tiers[i].rate;
  }
  return CONFIG.margin_tiers[CONFIG.margin_tiers.length-1].rate;
}

const $ = id=>document.getElementById(id);
function fmt(x){ return Number(x||0).toLocaleString(undefined,{minimumFractionDigits:CONFIG.precision,maximumFractionDigits:CONFIG.precision}); }

// Compute the neck label no-VAT portion that becomes +5 lei with VAT
function neckNoVatAdd(){
  return CONFIG.neck_label_vat_inclusive_add / (1 + CONFIG.vatRate);
}

// ------- Screen Print calc --------
function calcScreen(garment, colors, volume, neckOn){
  const c = Math.min(Math.max(colors,1),4); // cap at 4 for SP
  const v = Math.max(1, Math.floor(volume||0));

  const setup_amort = (CONFIG.setup_per_color * c) / v;
  const ink_cost = CONFIG.ink_per_color * c;
  const labor = CONFIG.labor_per_garment;

  let unit_cost_no_vat = garment + setup_amort + ink_cost + labor;
  unit_cost_no_vat *= (1 + CONFIG.overhead_rate);

  const margin = getMarginRate(v);
  let pppNoVat = unit_cost_no_vat * (1 + margin);

  // Add neck label at NO-VAT level so VAT naturally becomes +5 lei
  if(neckOn){ pppNoVat += neckNoVatAdd(); }

  const tpNoVat  = pppNoVat * v;
  const pppVat   = pppNoVat * (1 + CONFIG.vatRate);
  const tpVat    = tpNoVat  * (1 + CONFIG.vatRate);

  // return extended info
  return { pppNoVat, tpNoVat, pppVat, tpVat, unit_cost_no_vat, margin };
}

// ------- DTF calc --------
function calcDTF(garment, volume, neckOn){
  const v = Math.max(1, Math.floor(volume||0));
  const labor = CONFIG.labor_per_garment;

  let unit_cost_no_vat = garment + CONFIG.dtf_price_no_vat + labor;
  unit_cost_no_vat *= (1 + CONFIG.overhead_rate);

  const margin = getMarginRate(v);
  let pppNoVat = unit_cost_no_vat * (1 + margin);

  if(neckOn){ pppNoVat += neckNoVatAdd(); }

  const tpNoVat  = pppNoVat * v;
  const pppVat   = pppNoVat * (1 + CONFIG.vatRate);
  const tpVat    = tpNoVat  * (1 + CONFIG.vatRate);

  return { pppNoVat, tpNoVat, pppVat, tpVat, unit_cost_no_vat, margin };
}

// ---- DOM refs
const garment=$("garment"), colors=$("colors"), volume=$("volume");
const neckOnBtn=$("neckOn"), neckOffBtn=$("neckOff");
const dtfOnBtn=$("dtfOn"), dtfOffBtn=$("dtfOff");
const dtfAutoTag=$("dtfAutoTag"), dtfNote=$("dtfNote"), dtfWhy=$("dtfWhy");

// SP outputs
const p1=$("pppNoVat"), t1=$("tpNoVat"), p2=$("pppVat"), t2=$("tpVat");
// DTF outputs
const d1=$("dtfPppNoVat"), d2=$("dtfTpNoVat"), d3=$("dtfPppVat"), d4=$("dtfTpVat");
const dtfBlock=document.getElementById("dtfBlock");

// KPI refs
const tierLabel = $("tierLabel"), ppu = $("ppu"), targetProfit = $("targetProfit");
const needSp = $("needSp"), needDtf = $("needDtf");

// Profit breakdown refs
const profitBox = $("profitBox");
const activeMethod = $("activeMethod");
const pbVolume = $("pbVolume");
const pbRevenue = $("pbRevenue");
const pbCost = $("pbCost");
const pbGross = $("pbGross");
const pbTax = $("pbTax");
const pbNet = $("pbNet");

// --- state helpers
function segSet(btnOn, btnOff, on){
  btnOn.setAttribute("aria-pressed", on ? "true":"false");
  btnOff.setAttribute("aria-pressed", on ? "false":"true");
}
function segGet(btnOn){ return btnOn.getAttribute("aria-pressed")==="true"; }

function forcedDTFReason(){
  const v = parseInt(volume.value||"1",10);
  if(colors.value==="5+") return "5+ colors";
  if(v < 10) return "< 10 pcs";
  return "";
}

function applyDTFForceUI(reason){
  const forced = !!reason;
  dtfOnBtn.disabled = forced;
  dtfOffBtn.disabled = forced;
  dtfAutoTag.style.display = forced ? "inline-block" : "none";
  dtfNote.style.display = forced ? "block" : "none";
  dtfWhy.textContent = reason || "";
  if(forced){ segSet(dtfOnBtn, dtfOffBtn, true); }
}

function colorsToNumber(){ return (colors.value==="5+") ? 5 : parseInt(colors.value||"1",10); }

// Volum necesar pentru profit net target
function volForNetTarget(ppu_no_vat){
  if(ppu_no_vat <= 0) return "—";
  const net_per_unit = ppu_no_vat * (1 - CONFIG.micro_tax_rate);
  const target = Math.max(0, parseFloat(targetProfit.value||"0"));
  return Math.ceil(target / net_per_unit);
}

function renderTierAndTarget(g, c, v, neckOn, spBlocked, dtfOn){
  const margin = getMarginRate(v);
  tierLabel.textContent = Math.round(margin*100) + "%";

  // SP
  if(spBlocked){
    ppu.textContent = "—";
    needSp.textContent = "—";
  } else {
    const sp = calcScreen(g, c, v, neckOn);
    const profit_per_unit_no_vat = sp.pppNoVat - sp.unit_cost_no_vat;
    ppu.textContent = fmt(profit_per_unit_no_vat);
    needSp.textContent = volForNetTarget(profit_per_unit_no_vat);
  }

  // DTF
  if(dtfOn){
    const dx = calcDTF(g, v, neckOn);
    const ppu_dtf = dx.pppNoVat - dx.unit_cost_no_vat;
    needDtf.textContent = volForNetTarget(ppu_dtf);
  } else {
    needDtf.textContent = "—";
  }
}

function renderProfitBreakdown(){
  const isDtf = segGet(dtfOnBtn);
  const method = isDtf ? "DTF" : "Screen Print";
  const g = parseFloat(garment.value || "0");
  const c = colorsToNumber();
  const v = parseInt(volume.value || "1",10);
  const neckOn = segGet(neckOnBtn);

  const data = isDtf ? calcDTF(g,v,neckOn) : calcScreen(g,c,v,neckOn);
  const profit_unit = data.pppNoVat - data.unit_cost_no_vat;
  const gross = profit_unit * v;
  const micro = gross * CONFIG.micro_tax_rate;
  const net = gross - micro;

  activeMethod.textContent = method;
  pbVolume.textContent = v;
  pbRevenue.textContent = fmt(data.tpNoVat);
  pbCost.textContent = fmt(data.unit_cost_no_vat * v);
  pbGross.textContent = fmt(gross);
  pbTax.textContent = fmt(micro);
  pbNet.textContent = fmt(net);
}

// --- main update (with SP blocked at 5+ colors)
function update(){
  const g = parseFloat(garment.value || "0");
  const c = colorsToNumber();
  const v = parseInt(volume.value || "1",10);
  const neckOn = segGet(neckOnBtn);

  // DTF enforce based on rules
  const reason = forcedDTFReason();
  applyDTFForceUI(reason);

  // If 5+ colors => SP not available
  const spBlocked = (colors.value === "5+");

  if(spBlocked){
    p1.textContent = "N/A"; t1.textContent = "N/A";
    p2.textContent = "N/A"; t2.textContent = "N/A";
  }else{
    const sp = calcScreen(g, c, v, neckOn);
    p1.textContent = fmt(sp.pppNoVat); t1.textContent = fmt(sp.tpNoVat);
    p2.textContent = fmt(sp.pppVat);   t2.textContent = fmt(sp.tpVat);
  }

  // DTF block visibility & calc
  const dtfOn = segGet(dtfOnBtn);
  if(dtfOn){
    const dx = calcDTF(g, v, neckOn);
    d1.textContent = fmt(dx.pppNoVat); d2.textContent = fmt(dx.tpNoVat);
    d3.textContent = fmt(dx.pppVat);   d4.textContent = fmt(dx.tpVat);
    dtfBlock.style.display = "grid";
  } else {
    dtfBlock.style.display = "none";
  }

  // Margin badge + profit target
  renderTierAndTarget(g, c, v, neckOn, spBlocked, dtfOn);

  // If profit breakdown box is open, refresh its numbers live
  if(profitBox.style.display === "block"){ renderProfitBreakdown(); }
}

// --- listeners
["input","change"].forEach(ev=>{
  garment.addEventListener(ev, update);
  colors.addEventListener(ev, update);
  volume.addEventListener(ev, update);
});

$("toggleProfit").addEventListener("click", ()=>{
  if(profitBox.style.display==="none"){
    renderProfitBreakdown();
    profitBox.style.display="block";
    $("toggleProfit").textContent = "Hide profit breakdown";
  } else {
    profitBox.style.display="none";
    $("toggleProfit").textContent = "Show profit breakdown";
  }
});

neckOnBtn.addEventListener("click", ()=>{ segSet(neckOnBtn, neckOffBtn, true); update(); });
neckOffBtn.addEventListener("click", ()=>{ segSet(neckOnBtn, neckOffBtn, false); update(); });

dtfOnBtn.addEventListener("click", ()=>{
  if(dtfOnBtn.disabled) return; // forced
  segSet(dtfOnBtn, dtfOffBtn, true); update();
});
dtfOffBtn.addEventListener("click", ()=>{
  if(dtfOffBtn.disabled) return; // forced
  segSet(dtfOnBtn, dtfOffBtn, false); update();
});

// prefill from query
(function prefill(){
  const p = new URLSearchParams(location.search);
  if(p.has("g")) garment.value = p.get("g");
  if(p.has("c")) colors.value  = p.get("c");
  if(p.has("v")) volume.value  = p.get("v");

  const neckQ = p.get("n");
  if(neckQ==="0") segSet(neckOnBtn, neckOffBtn, false); else segSet(neckOnBtn, neckOffBtn, true);

  const dtfQ = p.get("d");
  if(dtfQ==="0") segSet(dtfOnBtn, dtfOffBtn, false); else segSet(dtfOnBtn, dtfOffBtn, true);

  update();
})();

$("reset").addEventListener("click", ()=>{
  garment.value=""; colors.value="1"; volume.value="";
  segSet(neckOnBtn, neckOffBtn, true);
  segSet(dtfOnBtn, dtfOffBtn, true);
  profitBox.style.display="none";
  $("toggleProfit").textContent = "Show profit breakdown";
  update();
});

// ----- COPY & SHARE (read button state, not visibility)
$("copy").addEventListener("click", async ()=>{
  const dtfOn = segGet(dtfOnBtn);
  const text = `SCREEN PRINT
Price per piece (no VAT): ${p1.textContent} ${CONFIG.currency}
Total price (no VAT): ${t1.textContent} ${CONFIG.currency}
Price per piece: ${p2.textContent} ${CONFIG.currency}
Total price: ${t2.textContent} ${CONFIG.currency}
${ dtfOn ? `
DTF
Price per piece (no VAT): ${d1.textContent} ${CONFIG.currency}
Total price (no VAT): ${d2.textContent} ${CONFIG.currency}
Price per piece: ${d3.textContent} ${CONFIG.currency}
Total price: ${d4.textContent} ${CONFIG.currency}
` : ""}`.trim();
  try{ await navigator.clipboard.writeText(text); alert("Outputs copied."); }catch(e){ alert("Copy failed. Select and copy manually."); }
});

$("share").addEventListener("click", async ()=>{
  const u = new URL(location.href);
  const params = new URLSearchParams();
  if(garment.value) params.set("g", garment.value);
  if(colors.value)  params.set("c", colors.value);
  if(volume.value)  params.set("v", volume.value);
  params.set("n", segGet(neckOnBtn) ? "1":"0");
  params.set("d", segGet(dtfOnBtn)  ? "1":"0");
  u.search = params.toString();
  try{ await navigator.clipboard.writeText(u.toString()); alert("Prefilled link copied."); }catch(e){ prompt("Copy this link:", u.toString()); }
});

// Register service worker if present (cache-bust param recommended)
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js?v=8').catch(()=>{});
  });
}

targetProfit.addEventListener("input", update);
</script>
</body>
</html>
